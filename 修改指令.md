# Gemini RPG Engine V9 修改指令

## 專案背景

這是一個基於 Gemini API 的單人 TRPG 網頁遊戲引擎，目前版本為 V8，使用純 HTML + CSS + JavaScript (Canvas) 開發。

現有功能包括：
- 世界觀生成與選擇
- 日曆系統（年/季/日/時辰）
- 命運點系統
- NPC 與人物關係網（可視化、可拖曳）
- 陣營聲望系統
- 打字機效果的劇情呈現

---

## 修改任務總覽

請依序完成以下 8 項功能新增/優化，每完成一項請告知我進度。

---

## 任務 1：JSON 容錯修復機制

**目標：** 大幅降低因 AI 回傳格式異常導致的報錯

**修改位置：** `GeminiService` 類別的 `call()` 方法

**修改方式：**

1. 建立一個獨立的 `tryParseJSON(text)` 函數，放在 `GeminiService` 類別之前

2. 此函數應依序嘗試以下修復策略：
   - 直接解析原始文字
   - 移除 markdown 的 ```json 和 ``` 包裹
   - 移除物件和陣列的尾隨逗號（trailing comma）
   - 將單引號替換為雙引號
   - 處理未轉義的換行符
   - 用正則表達式提取第一個完整的 JSON 物件 `{...}`
   - 每個步驟都用 try-catch 包裹，失敗則繼續下一個策略

3. 將 `call()` 方法中的 `JSON.parse(text)` 替換為呼叫 `tryParseJSON(text)`

4. 若所有修復策略都失敗，回傳 null 並顯示「AI 回應格式異常，正在重試...」

5. 可選：加入自動重試機制，最多重試 2 次

---

## 任務 2：自動存檔機制

**目標：** 防止刷新頁面或意外關閉導致遊戲進度丟失

**新增函數：**

1. `autoSave()` — 自動存檔函數
   - 將以下資料打包成物件：
     - `currentWorld`
     - `factionData`
     - `npcs`
     - `relationships`
     - `historyLog`（只保留最近 30 筆以控制大小）
     - `CALENDAR` 的所有屬性
     - `fatePoints`
     - `storyContext`
     - `playerCharacter`
     - `currentState`
     - `timestamp`（存檔時間）
   - 使用 `localStorage.setItem('rpg_autosave', JSON.stringify(saveData))` 儲存

2. `loadAutoSave()` — 載入存檔函數
   - 從 localStorage 讀取並解析資料
   - 還原所有遊戲狀態變數
   - 更新 UI 顯示（日曆、命運點、NPC 徽章等）
   - 根據 `currentState` 決定恢復到哪個畫面

3. `checkAutoSave()` — 檢查是否有存檔
   - 在 `init()` 函數開頭呼叫
   - 若有存檔，顯示一個確認對話框：「發現未完成的冒險，是否繼續？」
   - 提供「繼續」和「重新開始」兩個選項
   - 「重新開始」需清除 localStorage 中的存檔

**觸發時機：**
- 在 `processSceneResult()` 結束時呼叫 `autoSave()`
- 在 `handleOption()` 執行後呼叫 `autoSave()`
- 可選：監聽 `beforeunload` 事件，離開前自動存檔

**UI 新增：**
- 在設定模態視窗中加入「清除存檔」按鈕

---

## 任務 3：角色創建系統

**目標：** 讓玩家在開始冒險前自訂角色，增加代入感

**新增模態視窗：** `#character-create-modal`

**角色創建流程：**

1. 在選擇世界觀並點擊「踏入命運」後，先顯示角色創建視窗

2. 可定制項目：
   - **姓名**：文字輸入框，預設為「無名旅人」
   - **性別**：選項（男/女/其他/不指定）
   - **初始屬性**：提供 10 點自由分配到 4 個屬性
     - 力量（影響戰鬥、體力相關判定）
     - 智慧（影響解謎、知識相關判定）
     - 魅力（影響社交、說服相關判定）
     - 運氣（影響隨機事件結果）
   - **身世背景**：下拉選單，提供 5 個選項
     - 流浪者（無初始陣營傾向）
     - 沒落貴族（第一陣營 +15）
     - 商人之子（第二陣營 +15）
     - 神殿孤兒（第三陣營 +15）
     - 神秘來歷（隨機一項屬性 +3）
   - **性格特質**：可複選 1-2 個
     - 謹慎（risk 選項較少出現）
     - 魯莽（risk 選項較多出現）
     - 好奇（focus 選項較多出現）
     - 務實（normal 選項較多出現）

**資料儲存：**
- 擴展 `playerCharacter` 物件，新增：`gender`, `stats`, `background`, `traits`

**Prompt 整合：**
- 在 `generateOpeningScene()` 和 `generateNextScene()` 的系統提示詞中加入角色資訊
- 格式範例：「主角：{姓名}，{性別}，{身世背景}。性格：{特質}。屬性：力量{X}/智慧{X}/魅力{X}/運氣{X}」

**選項生成影響：**
- 在 `generateNextScene()` 的 prompt 中加入指令：根據角色特質調整選項類型的出現比例

---

## 任務 4：NPC 狀態系統

**目標：** 讓 NPC 有多種狀態，增加劇情深度與真實感

**新增常數：**
```
NPC_STATUS = {
  ACTIVE: 'active',        // 正常活躍
  INJURED: 'injured',      // 受傷
  MISSING: 'missing',      // 失蹤
  IMPRISONED: 'imprisoned', // 被囚禁
  BETRAYED: 'betrayed',    // 已背叛
  DEAD: 'dead'             // 死亡
}
```

**NPC 物件擴展：**
- 在每個 NPC 物件中新增 `status` 欄位，預設為 `'active'`

**AI Prompt 調整：**
- 在 `generateNextScene()` 的系統提示詞中：
  - 告知 AI 目前每個 NPC 的狀態
  - 指示 AI：死亡的 NPC 不應出現在劇情中，失蹤的 NPC 可作為線索提及
  - 在回傳的 JSON 中新增 `npcStatusChanges` 陣列，格式：`[{ "id": "npc_001", "newStatus": "injured", "reason": "戰鬥中受傷" }]`

**處理邏輯：**
- 在 `processSceneResult()` 中檢查 `npcStatusChanges`
- 更新對應 NPC 的狀態
- 狀態變更時顯示浮動文字通知

**關係網視覺化：**
- 修改 `drawNode()` 函數：
  - `dead`：節點變灰色，名字加刪除線
  - `missing`：節點半透明，加上「？」符號
  - `injured`：節點加紅色邊框
  - `imprisoned`：節點加鎖鏈圖示或條紋效果
  - `betrayed`：節點邊框變紫色

**NPC 詳情面板：**
- 在 `showNPCDetail()` 中顯示當前狀態
- 狀態不同顯示不同的描述文字

---

## 任務 5：存檔點與命運回溯系統

**目標：** 讓玩家可以回到過去的關鍵節點，改寫命運

**新增資料結構：**
```
savePoints = [
  {
    id: 'sp_001',
    name: '初遇神秘商人',
    timestamp: Date.now(),
    calendarString: '第一年 春月 初五 午後',
    snapshot: { /* 完整遊戲狀態快照 */ },
    isMajor: true  // 是否為重大節點
  }
]
```

**建立存檔點的時機：**
- 選擇 `risk` 類型選項時
- 觸發 `fateEvent` 時
- 遇到新 NPC 時
- 每經過遊戲內 1 個月（30 天）時
- 在建立時自動命名，格式：「{日期} - {最近事件摘要前10字}」

**新增 UI：**
- 工具列新增「命運長河」按鈕（圖示建議：⏳ 或 🌊）
- 點擊開啟 `#timeline-modal` 模態視窗
- 內容為垂直時間軸，從上（最早）到下（最新）排列所有存檔點
- 每個節點顯示：日期、名稱、是否為重大節點（重大節點用金色標記）
- 點擊節點顯示該時間點的簡要狀態（NPC 數量、陣營聲望等）
- 提供「回溯至此」按鈕

**回溯機制：**
- 回溯消耗命運點：普通節點 5 點，重大節點 8 點
- 回溯時：
  1. 確認對話框：「回溯將抹除此節點之後的所有記憶，是否確定？」
  2. 從 snapshot 還原所有遊戲狀態
  3. 刪除該節點之後的所有存檔點
  4. 刪除 historyLog 中該時間點之後的記錄
  5. 顯示過場動畫或文字：「命運之輪逆轉...」
  6. 回到 `STATE.CHOICE` 狀態

**存檔點上限：**
- 最多保留 50 個存檔點
- 超過時自動刪除最舊的非重大節點
- 使用 localStorage 儲存，key 為 `'rpg_savepoints'`

---

## 任務 6：命運點重擲系統

**目標：** 讓玩家對不滿意的事件結果有補救機會

**機制設計：**

1. 在 AI 的 `generateNextScene()` 回傳中新增欄位：
   - `rollRequired: true/false` — 此事件是否需要擲骰判定
   - `successRate: 0-100` — 成功率（根據角色屬性和情境決定）
   - `outcomes: { success: "成功描述", failure: "失敗描述", critical: "大成功描述" }`

2. 若 `rollRequired` 為 true：
   - 暫停劇情推進
   - 顯示擲骰介面：
     - 顯示成功率
     - 顯示影響此判定的屬性
     - 動畫：骰子滾動效果（可用 CSS 動畫）
     - 擲骰結果：1-100 隨機數
   - 判定結果：
     - `roll <= successRate * 0.2` → 大成功
     - `roll <= successRate` → 成功
     - `roll > successRate` → 失敗

3. 結果顯示後，提供「命運干涉」按鈕：
   - 消耗 3 命運點重擲
   - 最多重擲 2 次
   - 每次重擲成功率 +10（命運眷顧）

4. 確認結果後，根據判定結果選擇對應的 outcome 文字繼續劇情

**UI 設計：**
- 擲骰介面應有視覺張力
- 大成功用金色特效
- 失敗用暗紅色
- 重擲時骰子應有明顯的重新滾動動畫

---

## 任務 7：故事摘要自動壓縮

**目標：** 避免 historyLog 過長導致 API 請求超出 token 限制

**機制設計：**

1. 新增 `compressHistory()` 非同步函數

2. 觸發條件：當 `historyLog.length > 25` 時

3. 壓縮流程：
   - 取出 historyLog 的前 15 筆記錄
   - 呼叫 AI 生成摘要（約 100-150 字）
   - 將這 15 筆記錄替換為一筆 `{ role: 'Summary', text: '【前情摘要】...' }`
   - 保留後面的記錄不變

4. AI 摘要的 prompt：
   - 系統指令：「你是故事記錄員。請將以下事件記錄濃縮為 100-150 字的摘要，保留關鍵人物、重大事件、重要選擇。只回傳摘要文字，不需要 JSON 格式。」

5. 在 `generateNextScene()` 的 prompt 中：
   - 若 historyLog 開頭是 Summary，特別標註這是前情摘要
   - 格式：「【前情摘要】{摘要內容}\n\n【近期事件】{最近10筆記錄}」

6. 呼叫時機：在每次 `triggerSceneGeneration()` 開始時檢查並執行

---

## 任務 8：視覺風格調整（V7 風格）

**目標：** 將配色和粒子效果調整為 V7 版本的風格

**CSS 修改：**
- `body, html` 的 `background-color`：改為 `#15171e`

**CONFIG.colors 修改：**
- `bg`：`#15171e`
- `textPrimary`：`#d8d8d0`
- `textDim`：`#8f919c`
- `textGold`：`#deb887`
- `panelBg`：`rgba(28, 30, 38, 0.94)`
- `panelBorder`：`#4a4d5e`

**Particle 類別修改：**
- `this.r`：`Math.random() * 2 + 0.5`（粒子更大）
- `this.speed`：`Math.random() * 0.3 + 0.1`（飄動更快）
- `this.alpha`：`Math.random() * 0.4 + 0.1`（更明亮）
- `this.drift`：`(Math.random() - 0.5) * 0.2`（水平飄移更明顯）
- `draw()` 中的顏色：`rgba(255, 255, 255, ${this.alpha})`（純白色）

**粒子數量：**
- `init()` 中的粒子初始化：從 30 改為 50

**暈影效果：**
- 內圈半徑：`canvasHeight * 0.2`
- 外圈半徑：`canvasHeight * 0.9`
- 邊緣透明度：`0.4`

**載入文字顏色：**
- 改為 `#66a3e0`（亮藍色）

---

## 執行順序建議

1. **任務 1**（JSON 容錯）— 最基礎，影響後續所有功能的穩定性
2. **任務 8**（視覺風格）— 簡單，可快速完成
3. **任務 2**（自動存檔）— 重要的使用者體驗保障
4. **任務 4**（NPC 狀態）— 為後續功能打基礎
5. **任務 7**（摘要壓縮）— 確保長期遊玩的穩定性
6. **任務 3**（角色創建）— 增加遊戲深度
7. **任務 5**（命運回溯）— 核心玩法擴展
8. **任務 6**（重擲系統）— 錦上添花的功能

---

## 注意事項

1. 所有新增的模態視窗請保持與現有 UI 風格一致（深色主題、金色強調色、Noto Serif TC 字體）

2. 所有新增的 localStorage 操作都需要 try-catch 包裹，處理可能的儲存空間不足情況

3. 手機版適配：所有新 UI 都需要在 600px 以下螢幕寬度正常顯示

4. 每個任務完成後請保持程式碼可運行，方便逐步測試

5. 新增的 AI prompt 請使用繁體中文

6. 保留所有現有功能，不要刪除或破壞原有邏輯

---

## 檔案位置

原始檔案：`gemini-rpg-v8.html`（單一 HTML 檔案，包含所有 CSS 和 JavaScript）

修改後請輸出為：`gemini-rpg-v9.html`
