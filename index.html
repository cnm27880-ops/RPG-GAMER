<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini RPG Engine V9 - 命運織網</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="font-preload" aria-hidden="true">
        <span style="font-weight:200">載</span>
        <span style="font-weight:400">載</span>
        <span style="font-weight:700">載</span>
        <span style="font-weight:900">載</span>
    </div>

    <div id="calendar-display" class="calendar-display" style="display:none;">
        <div class="date" id="calendar-date">第一年 春月 初一</div>
        <div class="time" id="calendar-time">清晨</div>
    </div>

    <div id="fate-display" class="fate-points" style="display:none;">
        <span class="icon">✧</span>
        <span class="value" id="fate-value">0</span>
    </div>

    <div id="mutators-display" class="mutators-display" style="display:none;">
        <div id="mutators-list" class="mutators-list"></div>
    </div>

    <div class="toolbar">
        <button id="btn-shop" class="tool-btn" title="靈魂商店">
            🏪
            <span class="badge" id="soul-shard-badge" style="display:none;">0</span>
        </button>
        <button id="btn-relation" class="tool-btn" title="人物關係網">
            🕸️
            <span class="badge" id="npc-count" style="display:none;">0</span>
        </button>
        <button id="btn-timeline" class="tool-btn" title="命運長河">⏳</button>
        <button id="btn-sound" class="tool-btn" title="語音旁白">🔇</button>
        <button id="btn-log" class="tool-btn" title="冒險筆記">📜</button>
        <button id="btn-settings" class="tool-btn" title="設定">⚙️</button>
    </div>

    <div id="error-toast" class="error-toast" role="alert"></div>

    <div id="dice-overlay" class="dice-overlay">
        <div class="dice-container">
            <div class="dice-title" id="dice-title">命運檢定</div>
            <div class="dice-attribute" id="dice-attribute">威儀檢定</div>
            <div class="dice-display" id="dice-display">
                <div class="dice-face front">1</div>
                <div class="dice-face back">2</div>
                <div class="dice-face right">3</div>
                <div class="dice-face left">4</div>
                <div class="dice-face top">5</div>
                <div class="dice-face bottom">6</div>
            </div>
            <div class="dice-threshold" id="dice-threshold">目標：8 以上</div>
            <div class="dice-result-text" id="dice-result-text">成功！</div>
            <div class="dice-stat-bonus" id="dice-stat-bonus"></div>
            <div class="dice-reroll-section" id="dice-reroll-section">
                <button class="dice-reroll-btn" id="dice-reroll-btn" onclick="rerollDice()">
                    ✧ 命運介入 (3點)
                </button>
                <button class="dice-continue-btn" id="dice-continue-btn" onclick="continueDiceResult()">
                    接受命運
                </button>
            </div>
        </div>
    </div>

    <div id="relation-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleRelationModal(false)">×</span>
            <div class="modal-title">命 運 織 網</div>
            <canvas id="relationCanvas"></canvas>
            <div id="npc-detail" class="npc-detail-panel"></div>
        </div>
    </div>

    <div id="log-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleLogModal(false)">×</span>
            <div class="modal-title">冒 險 筆 記 (當前目標)</div>
            <div id="log-body" style="color:#a0a5b0;line-height:2;white-space:pre-wrap;"></div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:550px;">
            <span class="close-btn" onclick="toggleSettingsModal(false)">×</span>
            <div class="modal-title">引 擎 設 定</div>

            <!-- API Key 設定 -->
            <div class="api-key-section">
                <label>API Key</label>
                <input type="password" id="api-key-input" placeholder="輸入 API Key (支援多種格式)">
                <div style="font-size:12px;color:#8f919c;margin-top:8px;">
                    支援：Gemini (AIza...)、OpenAI (sk-...)、Claude (sk-ant-...)、Groq (gsk_...)、OpenRouter (sk-or-...)
                </div>
            </div>

            <!-- Provider 選擇 -->
            <div class="api-key-section" style="margin-top:15px;">
                <label>AI 模型供應商</label>
                <select id="provider-select" onchange="onProviderChange()" style="width:100%;padding:10px;background:#2a2d3a;border:1px solid #4a4d5e;color:#d8d8d0;border-radius:4px;">
                    <option value="auto">自動偵測 (依 API Key 判斷)</option>
                    <option value="gemini">Google Gemini</option>
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic Claude</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="groq">Groq</option>
                    <option value="openrouter">OpenRouter</option>
                    <option value="ollama">Ollama (本地模型)</option>
                </select>
            </div>

            <!-- 進階設定 (可摺疊) -->
            <details style="margin-top:15px;">
                <summary style="cursor:pointer;color:#deb887;font-size:14px;">進階設定</summary>
                <div style="padding:15px 0;">
                    <div class="api-key-section">
                        <label>模型名稱 (選填)</label>
                        <input type="text" id="model-input" placeholder="留空使用預設模型" style="width:100%;padding:10px;background:#2a2d3a;border:1px solid #4a4d5e;color:#d8d8d0;border-radius:4px;">
                    </div>
                    <div class="api-key-section" style="margin-top:10px;">
                        <label>自訂 API 端點 (選填)</label>
                        <input type="text" id="baseurl-input" placeholder="例如：https://api.example.com/v1" style="width:100%;padding:10px;background:#2a2d3a;border:1px solid #4a4d5e;color:#d8d8d0;border-radius:4px;">
                    </div>
                    <div style="margin-top:15px;">
                        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                            <input type="checkbox" id="streaming-toggle" style="width:18px;height:18px;">
                            <span>啟用流式傳輸 (文字一邊生成一邊顯示)</span>
                        </label>
                    </div>
                </div>
            </details>

            <!-- 當前 Provider 資訊 -->
            <div id="provider-info" style="margin-top:15px;padding:10px;background:#1a1d24;border-radius:4px;font-size:12px;color:#8f919c;display:none;">
                <span id="provider-info-text"></span>
            </div>

            <div style="text-align:center;margin-top:20px;">
                <button class="start-adventure-btn" style="padding:12px 40px;font-size:16px;" onclick="saveApiKey()">儲存設定</button>
            </div>

            <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #3a3d4a;">
                <button class="fate-action-btn" style="background:linear-gradient(135deg,#5a3030,#4a2020);" onclick="clearAutoSave();toggleSettingsModal(false);">
                    🗑️ 清除存檔
                </button>
            </div>
        </div>
    </div>

    <!-- 靈魂商店 Modal -->
    <div id="shop-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:900px;">
            <span class="close-btn" onclick="toggleShopModal(false)">×</span>
            <div class="modal-title">✧ 靈 魂 商 店 ✧</div>

            <div class="shop-header">
                <div class="shop-balance">
                    <span class="shop-currency-icon">💎</span>
                    <span id="shop-soul-shards">0</span>
                    <span class="shop-currency-label">靈魂碎片</span>
                </div>
                <div class="shop-stats" id="shop-stats">
                    <div class="shop-stat-item">遊戲次數：<span id="stat-total-games">0</span></div>
                    <div class="shop-stat-item">勝利次數：<span id="stat-victories">0</span></div>
                    <div class="shop-stat-item">最長存活：<span id="stat-longest">0</span>h</div>
                </div>
            </div>

            <div class="shop-tabs">
                <button class="shop-tab active" onclick="switchShopTab('backgrounds')">身世</button>
                <button class="shop-tab" onclick="switchShopTab('startingItems')">道具</button>
                <button class="shop-tab" onclick="switchShopTab('abilities')">能力</button>
            </div>

            <div id="shop-content" class="shop-content"></div>
        </div>
    </div>

    <div id="world-intro-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:800px;">
            <div id="world-intro-content" class="world-intro"></div>
        </div>
    </div>

    <div id="timeline-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <span class="close-btn" onclick="toggleTimelineModal(false)">×</span>
            <div class="modal-title">命 運 長 河</div>
            <div id="timeline-content" class="timeline-container"></div>
        </div>
    </div>

    <div id="character-create-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-title">角 色 創 建</div>
            <div class="character-create-form">
                <div class="form-group">
                    <label>角色姓名</label>
                    <input type="text" id="char-name" placeholder="無名旅人" maxlength="10">
                </div>

                <div class="form-group">
                    <label>性別</label>
                    <div class="radio-group" id="char-gender">
                        <label class="radio-item"><input type="radio" name="gender" value="男" checked><span>男</span></label>
                        <label class="radio-item"><input type="radio" name="gender" value="女"><span>女</span></label>
                        <label class="radio-item"><input type="radio" name="gender" value="其他"><span>其他</span></label>
                        <label class="radio-item"><input type="radio" name="gender" value="不指定"><span>不指定</span></label>
                    </div>
                </div>

                <div class="form-group">
                    <label>初始屬性 <span id="stat-points-remaining" style="color:#deb887;">(剩餘點數: 10)</span></label>
                    <div class="stat-allocator">
                        <div class="stat-row">
                            <span class="stat-name">👑 威儀</span>
                            <span class="stat-desc">對抗傲慢、守序、膽怯</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('authority', -1)">-</button>
                                <span id="stat-authority" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('authority', 1)">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">💖 共情</span>
                            <span class="stat-desc">對抗創傷、善良、感性</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('empathy', -1)">-</button>
                                <span id="stat-empathy" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('empathy', 1)">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">🎭 機變</span>
                            <span class="stat-desc">對抗貪婪、多疑、狡詐</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('cunning', -1)">-</button>
                                <span id="stat-cunning" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('cunning', 1)">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">🔬 理性</span>
                            <span class="stat-desc">對抗博學、冷靜、務實</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('logic', -1)">-</button>
                                <span id="stat-logic" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('logic', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>身世背景</label>
                    <select id="char-background">
                        <option value="wanderer">流浪者（無初始陣營傾向）</option>
                        <option value="noble">沒落貴族（第一陣營 +15）</option>
                        <option value="merchant">商人之子（第二陣營 +15）</option>
                        <option value="temple">神殿孤兒（第三陣營 +15）</option>
                        <option value="mystery">神秘來歷（隨機一項屬性 +3）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>性格特質 (可選1-2個)</label>
                    <div class="checkbox-group" id="char-traits">
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="cautious"><span>謹慎</span><small>risk選項較少出現</small></label>
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="reckless"><span>魯莽</span><small>risk選項較多出現</small></label>
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="curious"><span>好奇</span><small>focus選項較多出現</small></label>
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="practical"><span>務實</span><small>normal選項較多出現</small></label>
                    </div>
                </div>

                <div style="text-align:center;margin-top:25px;">
                    <button class="start-adventure-btn" onclick="confirmCharacterCreation()">開始冒險</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- 核心配置 -->
    <script src="js/config.js"></script>

    <!-- 通用 LLM 適配器（策略模式） -->
    <script src="js/llm-providers.js"></script>

    <!-- 提示詞管理系統 -->
    <script src="js/prompts.js"></script>

    <!-- 世界異變系統 -->
    <script src="js/world-mutators.js"></script>

    <!-- 傳承與解鎖系統 -->
    <script src="js/legacy-system.js"></script>
    <script src="js/shop-ui.js"></script>

    <!-- 遊戲狀態管理 -->
    <script src="js/game-state.js"></script>

    <!-- API 服務（向後相容層） -->
    <script src="js/api.js"></script>

    <!-- 遊戲系統 -->
    <script src="js/systems.js"></script>

    <!-- UI 元件 -->
    <script src="js/ui.js"></script>

    <!-- 主程式邏輯 -->
    <script src="js/main.js"></script>

    <!-- 初始化 GameManager（延遲到所有模組載入後） -->
    <script>
        // 確保所有模組載入後初始化 GameManager
        if (typeof initGameManager === 'function') {
            initGameManager();
        }
    </script>
</body>
</html>