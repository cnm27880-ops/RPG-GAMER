<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini RPG Engine V9 - 命運織網</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="font-preload" aria-hidden="true">
        <span style="font-weight:200">載</span>
        <span style="font-weight:400">載</span>
        <span style="font-weight:700">載</span>
        <span style="font-weight:900">載</span>
    </div>

    <div id="calendar-display" class="calendar-display" style="display:none;">
        <div class="date" id="calendar-date">第一年 春月 初一</div>
        <div class="time" id="calendar-time">清晨</div>
    </div>

    <div id="fate-display" class="fate-points" style="display:none;">
        <span class="icon">✧</span>
        <span class="value" id="fate-value">0</span>
    </div>

    <div class="toolbar">
        <button id="btn-relation" class="tool-btn" title="人物關係網">
            🕸️
            <span class="badge" id="npc-count" style="display:none;">0</span>
        </button>
        <button id="btn-timeline" class="tool-btn" title="命運長河">⏳</button>
        <button id="btn-sound" class="tool-btn" title="語音旁白">🔇</button>
        <button id="btn-log" class="tool-btn" title="冒險筆記">📜</button>
        <button id="btn-settings" class="tool-btn" title="設定">⚙️</button>
    </div>

    <div id="error-toast" class="error-toast" role="alert"></div>

    <div id="dice-overlay" class="dice-overlay">
        <div class="dice-container">
            <div class="dice-title" id="dice-title">命運檢定</div>
            <div class="dice-attribute" id="dice-attribute">力量檢定</div>
            <div class="dice-display" id="dice-display">?</div>
            <div class="dice-threshold" id="dice-threshold">目標：8 以上</div>
            <div class="dice-result-text" id="dice-result-text">成功！</div>
            <div class="dice-stat-bonus" id="dice-stat-bonus"></div>
            <div class="dice-reroll-section" id="dice-reroll-section">
                <button class="dice-reroll-btn" id="dice-reroll-btn" onclick="rerollDice()">
                    ✧ 命運介入 (3點)
                </button>
                <button class="dice-continue-btn" id="dice-continue-btn" onclick="continueDiceResult()">
                    接受命運
                </button>
            </div>
        </div>
    </div>

    <div id="relation-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleRelationModal(false)">×</span>
            <div class="modal-title">命 運 織 網</div>
            <canvas id="relationCanvas"></canvas>
            <div id="npc-detail" class="npc-detail-panel"></div>
        </div>
    </div>

    <div id="log-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleLogModal(false)">×</span>
            <div class="modal-title">冒 險 筆 記 (當前目標)</div>
            <div id="log-body" style="color:#a0a5b0;line-height:2;white-space:pre-wrap;"></div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-btn" onclick="toggleSettingsModal(false)">×</span>
            <div class="modal-title">引 擎 設 定</div>
            <div class="api-key-section">
                <label>API Key (支援 Gemini / OpenAI 格式)</label>
                <input type="password" id="api-key-input" placeholder="輸入 API Key (sk-... 或 AIza...)">
            </div>
            <div style="text-align:center;">
                <button class="start-adventure-btn" style="padding:12px 40px;font-size:16px;" onclick="saveApiKey()">儲存</button>
            </div>
            <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid #3a3d4a;">
                <button class="fate-action-btn" style="background:linear-gradient(135deg,#5a3030,#4a2020);" onclick="clearAutoSave();toggleSettingsModal(false);">
                    🗑️ 清除存檔
                </button>
            </div>
        </div>
    </div>

    <div id="world-intro-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:800px;">
            <div id="world-intro-content" class="world-intro"></div>
        </div>
    </div>

    <div id="timeline-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <span class="close-btn" onclick="toggleTimelineModal(false)">×</span>
            <div class="modal-title">命 運 長 河</div>
            <div id="timeline-content" class="timeline-container"></div>
        </div>
    </div>

    <div id="character-create-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-title">角 色 創 建</div>
            <div class="character-create-form">
                <div class="form-group">
                    <label>角色姓名</label>
                    <input type="text" id="char-name" placeholder="無名旅人" maxlength="10">
                </div>

                <div class="form-group">
                    <label>性別</label>
                    <div class="radio-group" id="char-gender">
                        <label class="radio-item"><input type="radio" name="gender" value="男" checked><span>男</span></label>
                        <label class="radio-item"><input type="radio" name="gender" value="女"><span>女</span></label>
                        <label class="radio-item"><input type="radio" name="gender" value="其他"><span>其他</span></label>
                        <label class="radio-item"><input type="radio" name="gender" value="不指定"><span>不指定</span></label>
                    </div>
                </div>

                <div class="form-group">
                    <label>初始屬性 <span id="stat-points-remaining" style="color:#deb887;">(剩餘點數: 10)</span></label>
                    <div class="stat-allocator">
                        <div class="stat-row">
                            <span class="stat-name">💪 力量</span>
                            <span class="stat-desc">影響戰鬥、體力相關判定</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('strength', -1)">-</button>
                                <span id="stat-strength" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('strength', 1)">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">📚 智慧</span>
                            <span class="stat-desc">影響解謎、知識相關判定</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('wisdom', -1)">-</button>
                                <span id="stat-wisdom" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('wisdom', 1)">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">💬 魅力</span>
                            <span class="stat-desc">影響社交、說服相關判定</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('charisma', -1)">-</button>
                                <span id="stat-charisma" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('charisma', 1)">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span class="stat-name">🍀 運氣</span>
                            <span class="stat-desc">影響隨機事件結果</span>
                            <div class="stat-controls">
                                <button class="stat-btn" onclick="adjustStat('luck', -1)">-</button>
                                <span id="stat-luck" class="stat-value">0</span>
                                <button class="stat-btn" onclick="adjustStat('luck', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>身世背景</label>
                    <select id="char-background">
                        <option value="wanderer">流浪者（無初始陣營傾向）</option>
                        <option value="noble">沒落貴族（第一陣營 +15）</option>
                        <option value="merchant">商人之子（第二陣營 +15）</option>
                        <option value="temple">神殿孤兒（第三陣營 +15）</option>
                        <option value="mystery">神秘來歷（隨機一項屬性 +3）</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>性格特質 (可選1-2個)</label>
                    <div class="checkbox-group" id="char-traits">
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="cautious"><span>謹慎</span><small>risk選項較少出現</small></label>
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="reckless"><span>魯莽</span><small>risk選項較多出現</small></label>
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="curious"><span>好奇</span><small>focus選項較多出現</small></label>
                        <label class="checkbox-item"><input type="checkbox" name="trait" value="practical"><span>務實</span><small>normal選項較多出現</small></label>
                    </div>
                </div>

                <div style="text-align:center;margin-top:25px;">
                    <button class="start-adventure-btn" onclick="confirmCharacterCreation()">開始冒險</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/systems.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>
</body>
</html>